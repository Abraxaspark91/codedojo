@echo off
chcp 65001 >nul
setlocal enabledelayedexpansion

:: ====================================================================
:: CodeDojo 실행 스크립트 (Windows용)
:: ====================================================================

echo.
echo ╔════════════════════════════════════════════════════════════════╗
echo ║                    CodeDojo 실행 프로그램                      ║
echo ╚════════════════════════════════════════════════════════════════╝
echo.

:: ────────────────────────────────────────────────────────────────────
:: 1단계: Python 설치 확인
:: ────────────────────────────────────────────────────────────────────
echo [1/4] Python 확인 중...

python --version >nul 2>&1
if errorlevel 1 (
    echo [X] Python을 찾을 수 없어요!
    echo.
    echo [해결 방법]
    echo   https://python.org 에서 Python 3.8 이상을 설치해주세요.
    echo   설치 시 "Add Python to PATH"를 꼭 체크하세요!
    echo.
    pause
    exit /b 1
)
echo [√] Python 확인 완료

:: ────────────────────────────────────────────────────────────────────
:: 2단계: 가상환경 및 의존성 확인
:: ────────────────────────────────────────────────────────────────────
echo [2/4] 가상환경 확인 중...

if not exist ".venv\Scripts\activate.bat" (
    echo [X] 가상환경이 설치되지 않았어요!
    echo.
    echo [해결 방법]
    echo   먼저 "setup_windows.bat" 파일을 더블클릭해서 설치해주세요.
    echo.
    pause
    exit /b 1
)
echo [√] 가상환경 확인 완료

:: ────────────────────────────────────────────────────────────────────
:: 3단계: LM Studio 실행 확인
:: ────────────────────────────────────────────────────────────────────
echo [3/4] LM Studio 연결 확인 중...

curl -s -o nul -w "%%{http_code}" http://localhost:1234 --connect-timeout 2 >nul 2>&1
if errorlevel 1 (
    echo [!] LM Studio 연결을 확인할 수 없어요.
    echo.
    echo [중요!]
    echo   1. LM Studio를 실행했나요?
    echo   2. 모델을 로드했나요?
    echo   3. Server를 시작했나요? (Start Server 버튼)
    echo.
    echo LM Studio가 준비되지 않았다면 피드백 기능이 작동하지 않아요.
    echo 그래도 계속 실행하시겠어요?
    echo.
    set /p CONTINUE="계속하기 (Y) / 취소하기 (N): "
    if /I not "!CONTINUE!"=="Y" (
        echo.
        echo 실행을 취소했습니다. LM Studio를 먼저 준비해주세요!
        echo.
        pause
        exit /b 0
    )
    echo.
    echo [!] 경고를 무시하고 실행합니다...
) else (
    echo [√] LM Studio 연결 확인 완료
)

:: ────────────────────────────────────────────────────────────────────
:: 4단계: CodeDojo 실행
:: ────────────────────────────────────────────────────────────────────
echo [4/4] CodeDojo 시작 중...
echo.

:: 가상환경 활성화
call .venv\Scripts\activate.bat

:: 백그라운드로 app.py 실행
echo CodeDojo 서버를 시작하고 있어요...
start /B python app.py >nul 2>&1

:: 서버가 시작될 때까지 대기
echo 서버가 준비될 때까지 잠시만 기다려주세요...
timeout /t 5 /nobreak >nul

:: 기본 브라우저로 열기
echo.
echo ╔════════════════════════════════════════════════════════════════╗
echo ║                    CodeDojo 실행 완료! 🎉                      ║
echo ╚════════════════════════════════════════════════════════════════╝
echo.
echo 브라우저를 열고 있어요...
echo.
echo [주소] http://127.0.0.1:7860
echo.
echo ──────────────────────────────────────────────────────────────────
echo  종료하려면: 이 창을 닫거나 Ctrl+C를 누르세요
echo ──────────────────────────────────────────────────────────────────
echo.

start http://127.0.0.1:7860

:: 프로세스가 종료될 때까지 대기 (콘솔 창 유지)
python app.py
