#!/bin/bash

# ====================================================================
# CodeDojo Mac 앱 번들 실행 스크립트
# ====================================================================
# 이 스크립트는 CodeDojo.app에서 실행됩니다.
# ====================================================================

# 색상 정의
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# 프로젝트 루트 디렉토리로 이동
# .app 번들에서 실행되므로 상위 디렉토리로 이동
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_DIR="$(cd "$SCRIPT_DIR/../../.." && pwd)"

cd "$PROJECT_DIR" || {
    osascript -e 'display dialog "프로젝트 디렉토리를 찾을 수 없습니다!" buttons {"확인"} default button "확인" with icon stop with title "CodeDojo"'
    exit 1
}

# ────────────────────────────────────────────────────────────────────
# 함수: 에러 메시지 표시
# ────────────────────────────────────────────────────────────────────
show_error() {
    local message="$1"
    osascript -e "display dialog \"$message\" buttons {\"확인\"} default button \"확인\" with icon stop with title \"CodeDojo 오류\""
}

# 함수: 정보 메시지 표시
show_info() {
    local message="$1"
    osascript -e "display dialog \"$message\" buttons {\"확인\"} default button \"확인\" with icon note with title \"CodeDojo\""
}

# 함수: 예/아니오 질문
ask_question() {
    local message="$1"
    osascript -e "display dialog \"$message\" buttons {\"아니오\", \"예\"} default button \"예\" with icon caution with title \"CodeDojo\""
}

# ────────────────────────────────────────────────────────────────────
# 1단계: Python 확인
# ────────────────────────────────────────────────────────────────────
if command -v python3 &> /dev/null; then
    PYTHON_CMD=python3
elif command -v python &> /dev/null; then
    PYTHON_CMD=python
else
    show_error "Python을 찾을 수 없습니다!\\n\\n다음 사이트에서 Python 3.8 이상을 설치해주세요:\\nhttps://python.org\\n\\n또는 Homebrew로 설치:\\nbrew install python3"
    exit 1
fi

# ────────────────────────────────────────────────────────────────────
# 2단계: 가상환경 확인
# ────────────────────────────────────────────────────────────────────
if [ ! -f ".venv/bin/activate" ]; then
    result=$(ask_question "가상환경이 설치되지 않았습니다!\\n\\n먼저 설치를 진행할까요?")
    if [[ $result == *"예"* ]]; then
        # Terminal에서 setup 스크립트 실행
        open -a Terminal.app "$PROJECT_DIR/setup_mac.command"
        show_info "설치가 완료되면 다시 CodeDojo를 실행해주세요."
        exit 0
    else
        exit 0
    fi
fi

# ────────────────────────────────────────────────────────────────────
# 3단계: LM Studio 확인
# ────────────────────────────────────────────────────────────────────
if ! curl -s -o /dev/null -w "%{http_code}" --connect-timeout 2 http://localhost:1234 > /dev/null 2>&1; then
    result=$(ask_question "LM Studio가 실행되지 않은 것 같습니다.\\n\\nLM Studio 없이도 앱은 실행되지만,\\nAI 피드백 기능은 작동하지 않습니다.\\n\\n계속 진행할까요?")
    if [[ $result != *"예"* ]]; then
        exit 0
    fi
fi

# ────────────────────────────────────────────────────────────────────
# 4단계: CodeDojo 실행
# ────────────────────────────────────────────────────────────────────
# 가상환경 활성화
source .venv/bin/activate

# 백그라운드로 app.py 실행
$PYTHON_CMD app.py > /dev/null 2>&1 &
APP_PID=$!

# 서버가 시작될 때까지 대기
sleep 5

# 브라우저 열기
open http://127.0.0.1:7860

# 성공 메시지
osascript -e 'display dialog "CodeDojo가 시작되었습니다! 🎉\n\n브라우저가 열립니다.\n\n종료하려면:\n작업 관리자에서 Python을 종료하거나\n터미널에서 Ctrl+C를 누르세요." buttons {"확인"} default button "확인" with title "CodeDojo"'

# 프로세스가 종료될 때까지 대기하지 않고 종료
# (백그라운드에서 계속 실행됨)
exit 0
